' Gambas class file
' dfhLog- Hamradio LogBook
'     Copyright (C) 2009  Jesús Guardón, EA7DFH <ea7dfh@gmail.com>
' 
'     This program is free software: you can redistribute it and/or modify
'     it under the terms of the GNU General Public License as published by
'     the Free Software Foundation, either version 3 of the License, or
'     (at your option) any later version.
' 
'     This program is distributed in the hope that it will be useful,
'     but WITHOUT ANY WARRANTY; without even the implied warranty of
'     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
'     GNU General Public License for more details.
' 
'     You should have received a copy of the GNU General Public License
'     along with this program.  If not, see <http://www.gnu.org/licenses/>.

PRIVATE cLabel AS qLabel
PRIVATE aLabels AS NEW Collection
PRIVATE currLabel AS String
PRIVATE sett AS Settings
PRIVATE canvas AS Object
PRIVATE imgBG AS Picture
PRIVATE zoomH AS Float
PRIVATE zoomV AS Float


PUBLIC SUB Form_Open()
    DIM s AS String
    canvas = daQSL
    sett = NEW Settings(User.Home &/ ".dfh_Log/printQSL.conf", "printQSL")
    imgBG = Picture[sett["BGImage/Path"]]
    chkBG.Value = sett["Image/Display", 0]
    FOR EACH s IN ComboBox1.List
        cLabel = NEW qLabel
        cLabel.sName = s
        ' cLabel.fFont = Font[sett[s & "/Font"]]
        ' cLabel.fSize = sett[s & "/Size", 10]
        ' cLabel.iColor = sett[s & "/Color", 0]
        cLabel.iX = sett[s & "/X", 20]
        cLabel.iY = sett[s & "/Y", 20]
        'cLabel.sText = sett[s & "/Text", s]
        aLabels.Add(cLabel, s)
        drawPage()
    
    NEXT 
    
    labelX.Text = aLabels[ComboBox1.Text].iX 
    labelY.Text = aLabels[ComboBox1.Text].iY
    lblPath.Text = sett["BGImage/Path"]
    'lblPrinter.Text = Printer.Name
    lblRes.Text = "Res: " & Printer.Resolution & " dpi"
    
   
END

PUBLIC SUB Button2_Click()
    currLabel = ComboBox1.Text
    
    IF Dialog.SelectFont() = TRUE THEN RETURN 
    
    aLabels[currLabel].fFont = Dialog.Font
    sett[currLabel & "/Font"] = Dialog.Font.Name
    sett[currLabel & "/Size"] = Dialog.Font.Size
    sett[aLabels.Key & "/Italic"] = Dialog.Font.Italic
    sett[aLabels.Key & "/Bold"] = Dialog.Font.Bold
    
    drawPage() 

END

PUBLIC SUB daQSL_MouseMove()

    lblMouse.Text = "X= " & Format((Mouse.X / 10) * 3, "0.0") & " mm / Y= " & Format((Mouse.Y / 10) * 3, "0.0") & " mm"  
    'lblY.Text = "Y= " & Format((Mouse.Y / 10) * 3, "0.0") & " mm"
  

END

PRIVATE SUB clear()
    DIM pr AS Float
    pr = Printer.Resolution / 29
    zoomH = 466 / 140
    zoomV = 300 / 90
     
    daQSL.Clear
    Draw.Begin(canvas)
    
    Draw.Reset()
    IF canvas = daQSL THEN  
      Draw.Scale(zoomH, zoomV)
      
    ELSE 
      Draw.Scale((zoomH * pr) / 3, (zoomV * pr) / 3)
      Draw.Translate(290 - 120, 0)
            
    ENDIF 
  
END


PRIVATE SUB drawPage()
    
  clear()
  IF chkBG.Value = TRUE THEN TRY Draw.Picture(imgBG, 0, 0, 140, 90)
  Draw.Rect(1, 1, 138, 88)
  
  FOR EACH cLabel IN aLabels
  
    Draw.ForeColor = sett[aLabels.Key & "/Color", 0]
    Draw.Font.Name = sett[aLabels.Key & "/Font", "Arial"]
    Draw.Font.Size = sett[aLabels.Key & "/Size", 10]
    Draw.Font.Bold = sett[aLabels.Key & "/Bold", FALSE]
    Draw.Font.Italic = sett[aLabels.Key & "/Italic", FALSE]
    Draw.Text(cLabel.sName, cLabel.iX, cLabel.iY)
    sett[aLabels.Key & "/X"] = cLabel.iX
    sett[aLabels.Key & "/Y"] = cLabel.iY
    
   NEXT 

    Draw.End()
  
  
END


PUBLIC SUB ComboBox1_Click()

  currLabel = ComboBox1.Text
  ColorButton1.Color = sett[currLabel & "/Color", 0]
  
   labelX.Text = sett[currLabel & "/X", 20]
   labelY.Text = sett[currLabel & "/Y", 20]
   
END

PUBLIC SUB ColorButton1_Change()

  currLabel = ComboBox1.Text
  aLabels[currLabel].iColor = Dialog.Color
  sett[currLabel & "/Color"] = Dialog.Color
  drawPage()

END

PUBLIC SUB Button7_Click()

  ME.Close()
 
END

PUBLIC SUB btnUp_Click()
    DIM i AS Float
    i = CInt(labelY.Text)
    currLabel = ComboBox1.Text
    IF i > 0 THEN 
        i -= 1
        aLabels[currLabel].iY = i        
        labelY.Text = i
        drawPage()

    ENDIF 

END

PUBLIC SUB btnDwn_Click()
    DIM i AS Float
    i = CInt(labelY.Text)
    currLabel = ComboBox1.Text
    IF i < 90 THEN 
        i += 1
        aLabels[currLabel].iY = i        
        labelY.Text = i
        drawPage()

    ENDIF 

  

END

PUBLIC SUB btnLeft_Click()
    DIM i AS Float
    i = CInt(labelX.Text)
    currLabel = ComboBox1.Text
    IF i > 0 THEN 
        i -= 1
        aLabels[currLabel].iX = i        
        labelX.Text = i
        drawPage()

    ENDIF 
  

END

PUBLIC SUB btnRight_Click()
    DIM i AS Float
    i = CInt(labelX.Text)
    currLabel = ComboBox1.Text
    IF i < 140 THEN 
        i += 1
        aLabels[currLabel].iX = i        
        labelX.Text = i
        drawPage()

    ENDIF 
  

END

PUBLIC SUB chkBG_Click()
    drawPage()
    sett["Image/Display"] = chkBG.Value

END

PUBLIC SUB Button1_Click()

  Printer.Setup()
  lblPrinter.Text = Printer.Name
  

END

PUBLIC SUB Button3_Click()
   INC Application.Busy 
  canvas = Printer
  ' Printer.Orientation = Printer.Landscape
  ' Printer.Size = "A6"
  ' Printer.ColorMode = Printer.Black
  drawPage()
  DEC Application.Busy
  canvas = daQSL
  drawPage()
  

END

PUBLIC SUB Button4_Click()

  Dialog.Title = ("Choose a background image")
  Dialog.Filter = ["*.png;*.jpg;*.jpeg;*.gif;*.bmp", ("Picture files")]
  IF Dialog.OpenFile() THEN RETURN 
  imgBG = Picture[Dialog.Path]
  sett["BGImage/Path"] = Dialog.Path
  lblPath.Text = Dialog.Path
  drawPage()
  

END

PUBLIC SUB Form_Close()
    ' IF Message.Question("Sure?", "Yes", "No") = 2 THEN STOP EVENT 
    ' RETURN 
    
  canvas = NULL
  cLabel = NULL
  aLabels = NULL
  imgBG = NULL
  

END

PUBLIC SUB mnuDes_Click()

  'FPrinter.ShowModal()

END
