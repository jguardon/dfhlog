' Gambas class file
' dfhLog- Hamradio LogBook
'     Copyright (C) 2009  Jesús Guardón, EA7DFH <ea7dfh@gmail.com>
' 
'     This program is free software: you can redistribute it and/or modify
'     it under the terms of the GNU General Public License as published by
'     the Free Software Foundation, either version 3 of the License, or
'     (at your option) any later version.
' 
'     This program is distributed in the hope that it will be useful,
'     but WITHOUT ANY WARRANTY; without even the implied warranty of
'     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
'     GNU General Public License for more details.
' 
'     You should have received a copy of the GNU General Public License
'     along with this program.  If not, see <http://www.gnu.org/licenses/>.
 

PRIVATE $upLimit AS Float = 14.35
PRIVATE $dwnLimit AS Float = 14.0
PRIVATE $Freq AS Float = 14.100
PRIVATE $zoom AS Float
PRIVATE $End AS Float
PRIVATE $Start AS Float
PRIVATE $Ffin AS Float
PRIVATE $F2 AS Float
PRIVATE $vfo0 AS Float
PRIVATE $Ba AS Boolean
PRIVATE $DH AS Float
PRIVATE $FullSpan AS Boolean = FALSE
PRIVATE $Band AS String = "20M"
PRIVATE $OldBand AS String = "20M"
PRIVATE $cbm AS cDXBM

PUBLIC SUB Form_Open()
    ME.Left = FMain.ini["WbandMap/Left", ME.Left]
    ME.Top = FMain.ini["WbandMap/Top", ME.Top]  
    ME.Height = FMain.ini["WbandMap/Height", ME.Height]
    ME.Width = FMain.ini["WbandMap/Width", ME.Width]
    $zoom = FMain.ini["WbandMap/Zoom", 100]
    getBandLimits(FMain.cBand)
END

PUBLIC SUB daBandMap_Draw()
    DIM F, P, R, rndN AS Integer
    DIM i, j, iStep, iEnd, iIni, p0 AS Float
    DIM sFreq, sAux AS String

    ' Draw ticked scale placeholder
    Draw.FillStyle = Fill.Solid
    Draw.Foreground = Color.Red
    Draw.FillColor = Color.LightBackground
    Draw.Rect(0, 0, 70, daBandMap.Height)
    Draw.Foreground = Color.Black
    Draw.Font.Size = 7
    
    $Band = FMain.cBand
    $DH = Draw.H
    iIni = $dwnLimit * 1000
    iEnd = $upLimit * 1000
    F = Int($Freq * 1000 - $zoom / 2)
    $End = F
    iStep = (Draw.H / $zoom) 

    FOR i = 0 TO Draw.H STEP iStep
        IF F > iEnd OR F < iIni THEN 
            Draw.ForeColor = Color.Red
        ELSE 
            Draw.ForeColor = Color.Black
        END IF

        IF F MOD 5 = 0 THEN
            Draw.Line(68 - 10, i, 68, i)
            sFreq = Replace$(Format$(F / 1000, "##0.000"), ",", ".")
            Draw.Text(sFreq, 55 - Draw.Font.Width(sFreq), i - Draw.Font.Height(sFreq) / 2,,, Align.Right)
            'DEBUG F, $zoom
        ELSE 
            Draw.Line(68 - 5, i, 68, i)
        END IF
        INC F
    NEXT 

    $Ffin = F - 1

    Draw.Picture(Picture["icons/dial.png"], 62, (daBandMap.Height / 2) - 4)

    FOR j = 0 TO global.$cSpot.Count - 1
        $cbm = global.$cSpot[j]
        IF $cbm.dxFreq >= $End AND $cbm.dxFreq <= $Ffin THEN 
            P = Int($cbm.dxFreq - $End) / ($Ffin - $End) * Draw.H
            Draw.ForeColor = Color.Black
            Draw.Font.Size = 8
            Draw.Line(70, P, 90, P)
            Draw.FillColor = Color.RGB(240, 240, 240)
            Draw.ForeColor = Color.White
            Draw.Rect(90, P - Draw.Font.Height($cbm.dxCall) / 2, Draw.W - 100, Draw.Font.Height($cbm.dxCall)) 
            Draw.ForeColor = $cbm.dxColor
            Draw.Text($cbm.dxCall, 93, P - Draw.Font.Height($cbm.dxCall) / 2,,, Align.Left)
        ENDIF 
    NEXT
END

PUBLIC SUB Control(VFO AS Float)
    $Freq = VFO / 1000
    daBandMap.Refresh
END

PUBLIC SUB daRefresh()
    daBandMap.Refresh
END

PUBLIC SUB getBandLimits(band AS String)
 
    SELECT CASE band
        CASE "2190M"
            $upLimit AS Float = 0.1378
            $dwnLimit AS Float = 0.1357
            $Freq AS Float = 0.1360
        CASE "160M"
            $upLimit AS Float = 2.0
            $dwnLimit AS Float = 1.8
            $Freq AS Float = 1.9
        CASE "80M"
            $upLimit AS Float = 3.9
            $dwnLimit AS Float = 3.5
            $Freq AS Float = 3.6
        CASE "40M"
            $upLimit AS Float = 7.2
            $dwnLimit AS Float = 7.0
            $Freq AS Float = 7.100
        CASE "30M"
            $upLimit AS Float = 10.15
            $dwnLimit AS Float = 10.1
            $Freq AS Float = 10.12
        CASE "20M"
            $upLimit AS Float = 14.35
            $dwnLimit AS Float = 14.0
            $Freq AS Float = 14.100
        CASE "17M"
            $upLimit AS Float = 18.168
            $dwnLimit AS Float = 18.068
            $Freq AS Float = 18.100
        CASE "15M"
            $upLimit AS Float = 21.45
            $dwnLimit AS Float = 21.0
            $Freq AS Float = 21.200
        CASE "12M"
            $upLimit AS Float = 24.99
            $dwnLimit AS Float = 24.89
            $Freq AS Float = 24.95
        CASE "10M"
            $upLimit AS Float = 29.7
            $dwnLimit AS Float = 28
            $Freq AS Float = 28.5
        CASE "6M"
            $upLimit AS Float = 52.0
            $dwnLimit AS Float = 50.0
            $Freq AS Float = 50.2
        CASE "4M"
            $upLimit AS Float = 70.5
            $dwnLimit AS Float = 70.0
            $Freq AS Float = 70.2
        CASE "2M"
            $upLimit AS Float = 146.0
            $dwnLimit AS Float = 144.0
            $Freq AS Float = 144.300
        CASE "70CM"
            $upLimit AS Float = 440.0
            $dwnLimit AS Float = 430.0
            $Freq AS Float = 433.2
        CASE "23CM"
            $upLimit AS Float = 1300.0
            $dwnLimit AS Float = 1240.0
            $Freq AS Float = 1296.0
        CASE "13CM"
            $upLimit AS Float = 2450.0
            $dwnLimit AS Float = 2300.0
            $Freq AS Float = 2350.0
        CASE "6CM"
            $upLimit AS Float = 5850.0
            $dwnLimit AS Float = 5650.0
            $Freq AS Float = 5700.0
        CASE "3CM"
            $upLimit AS Float = 10500.0
            $dwnLimit AS Float = 10000.0
            $Freq AS Float = 10200.0
        CASE "1.25CM"
            $upLimit AS Float = 24250.0
            $dwnLimit AS Float = 24000.0
            $Freq AS Float = 24100.0
        CASE "6MM"
            $upLimit AS Float = 47200.0
            $dwnLimit AS Float = 47000.0
            $Freq AS Float = 47100.0
    END SELECT
    daBandMap.Refresh
END

PUBLIC SUB Form_Resize()
    
    daBandMap.Refresh  

END

PUBLIC SUB btnZoomIn_Click()
    
    $zoom -= 10
    daBandMap.Refresh 

END

PUBLIC SUB btnZoomOut_Click()
    
    $zoom += 10
    daBandMap.Refresh

END

PUBLIC SUB btnZoomFit_Click()
    
    $zoom = ($upLimit - $dwnLimit) * 1000
    daBandMap.Refresh

END

PUBLIC SUB Form_Close()
    FMain.ini["WbandMap/Top"] = ME.ScreenY
    FMain.ini["WbandMap/Left"] = ME.ScreenX
    FMain.ini["WbandMap/Height"] = ME.Height
    FMain.ini["WbandMap/Width"] = ME.Width
    FMain.ini["WbandMap/Zoom"] = $zoom
    FMain.bandmapToggle
    FMain.ini.Save
END

PUBLIC SUB btnReset_Click()
    $zoom = 100
    daBandMap.Refresh

END

PUBLIC SUB btnClear_Click()

    global.$cSpot.Clear
    daBandMap.Refresh

END

PUBLIC SUB daBandMap_MouseDown()
    DIM Fm AS Float
    IF Mouse.Left THEN 
        Fm = ($End + ($Ffin - $End) * Mouse.Y / $DH) 
        IF FMain.$hamlibconnected THEN 
            FMain.setFreq(Fm)
        ELSE
            Control(Fm)
        ENDIF
    ENDIF
END

PUBLIC SUB daBandMap_MouseWheel()

    IF Mouse.Delta > 0 THEN $Freq += 0.01
    IF Mouse.Delta < 0 THEN $Freq -= 0.01
    IF FMain.$hamlibconnected THEN FMain.setFreq($Freq * 1000) 
    daBandMap.Refresh
END
